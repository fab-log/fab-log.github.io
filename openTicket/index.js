const tickets = [
    {
        id: 0,
        bubbleHue: 300,
        date: [{timestamp: 1702237814748, value: 1702227814748}],
        state: [{timestamp: 1702227814748, value: -1}],
        title: [{timestamp: 1702227814748, value: "Walk the dog"}],
        description: [{timestamp: 1702227824748, value: "things todoooo"}, {timestamp: 1702227829748, value: "things to do"}],
        dueDate: [{timestamp: 1702227824748, value: "2024-02-01"}],
        owner: [{timestamp: 1702227824748, value: "fabian"}],
        prio: [{timestamp: 1702227824748, value: 1}],
        subtasks: [
            {
                subId: 0,
                date: 1702227914748,
                editor: "fabian",
                type: 2,
                state: 1,
                note: "looooooong string"
            }
        ]
    }, {
        id: 1,
        bubbleHue: 120,
        date: [{timestamp: 1702237814748, value: 1702137814748}],
        state: [{timestamp: 1702237814748, value: 1}],
        title: [{timestamp: 1702237814748, value: "Feed the cat"}],
        description: [{timestamp: 1702237824748, value: "many things todo"}],
        dueDate: [{timestamp: 1702237824748, value: "2024-03-02"}],
        owner: [{timestamp: 1702237824748, value: "anne"}],
        prio: [{timestamp: 1702237824748, value: 2}],
        subtasks: [
            {
                subId: 0,
                date: 1702237914748,
                editor: "anne",
                type: 2,
                state: 1,
                note: "long story short"
            }, {
                subId: 1,
                date: 1702237924748,
                editor: "anne",
                type: 2,
                state: 2,
                note: "another long story"
            }
        ]
    }, {
        id: 2,
        bubbleHue: 330,
        date: [{timestamp: 1702237814748, value: 1702047814748}],
        state: [{timestamp: 1702247814748, value: 1}],
        title: [{timestamp: 1702247814748, value: "Eat the fish"}],
        description: [{timestamp: 1702247824748, value: "even more things todo"}],
        dueDate: [{timestamp: 1702247824748, value: ""}],
        owner: [{timestamp: 1702247824748, value: "fabian"}],
        prio: [{timestamp: 1702247824748, value: 2}],
        subtasks: [
            {
                subId: 0,
                date: 1702247914748,
                editor: "fabian",
                type: 2,
                state: 1,
                note: "boring story"
            }, {
                subId: 1,
                date: 1702247924748,
                editor: "fabian",
                type: 2,
                state: 2,
                note: "never ending story"
            }
        ]
    }, {
        id: 3,
        bubbleHue: 90,
        date: [{timestamp: 1702237814748, value: 1701227814748}],
        state: [{timestamp: 1702227814748, value: -1}],
        title: [{timestamp: 1702227814748, value: "Ride the horse"}],
        description: [{timestamp: 1702227824748, value: "things todoooo"}, {timestamp: 1702227829748, value: "things to do"}],
        dueDate: [{timestamp: 1702227824748, value: "2024-03-04"}],
        owner: [{timestamp: 1702227824748, value: "bo"}],
        prio: [{timestamp: 1702227824748, value: 1}],
        subtasks: [
            {
                subId: 0,
                date: 1702227914748,
                editor: "bo",
                type: 2,
                state: 1,
                note: "looooooong string"
            }
        ]
    }, {
        id: 4,
        bubbleHue: 30,
        date: [{timestamp: 1702237814748, value: 1700137814748}],
        state: [{timestamp: 1702237814748, value: 1}],
        title: [{timestamp: 1703237814748, value: "Tame the fox"}],
        description: [{timestamp: 1702237824748, value: "many things todo"}],
        dueDate: [{timestamp: 1702237824748, value: "2024-02-05"}],
        owner: [{timestamp: 1702237824748, value: "anne"}],
        prio: [{timestamp: 1702237824748, value: 2}],
        subtasks: [
            {
                subId: 0,
                date: 1702237914748,
                editor: "anne",
                type: 2,
                state: 1,
                note: "long story short"
            }, {
                subId: 1,
                date: 1702237924748,
                editor: "fabian",
                type: 2,
                state: 2,
                note: "another long story"
            }
        ]
    }, {
        id: 5,
        bubbleHue: 0,
        date: [{timestamp: 1702237814748, value: 1699047814748}],
        state: [{timestamp: 1702247814748, value: 1}],
        title: [{timestamp: 1702247814748, value: "Fight the lion"}],
        description: [{timestamp: 1702247824748, value: "even more things todo"}],
        dueDate: [{timestamp: 1702247824748, value: ""}],
        owner: [{timestamp: 1702247824748, value: "liu"}],
        prio: [{timestamp: 1702247824748, value: 0}],
        subtasks: [
            {
                subId: 0,
                date: 1702247914748,
                editor: "liu",
                type: 3,
                state: 1,
                note: "boring story"
            }, {
                subId: 1,
                date: 1702247924748,
                editor: "liu",
                type: 2,
                state: 2,
                note: "never ending story"
            }
        ]
    }, {
        id: 6,
        bubbleHue: 60,
        date: [{timestamp: 1702237814748, value: 1703091086182}],
        state: [{timestamp: 1702227814748, value: -1}],
        title: [{timestamp: 1702227814748, value: "Smash the bug"}],
        description: [{timestamp: 1702227824748, value: "things todoooo"}, {timestamp: 1702227829748, value: "things to do"}],
        dueDate: [{timestamp: 1702227824748, value: "2024-03-06"}, {timestamp: 1703227824748, value: "2024-02-06"}],
        owner: [{timestamp: 1702227824748, value: "fabian"}],
        prio: [{timestamp: 1702227824748, value: 1}],
        subtasks: [
            {
                subId: 0,
                date: 1702227914748,
                editor: "fabian",
                type: 2,
                state: 1,
                note: "looooooong string"
            }
        ]
    }, {
        id: 7,
        bubbleHue: 90,
        date: [{timestamp: 1702237814748, value: 1703040975569}],
        state: [{timestamp: 1702237814748, value: 1}],
        title: [{timestamp: 1702237814748, value: "Catch the rabbit"}],
        description: [{timestamp: 1702237824748, value: "many things todo"}],
        dueDate: [{timestamp: 1702237824748, value: "2024-01-14"}],
        owner: [{timestamp: 1702237824748, value: "anne"}],
        prio: [{timestamp: 1702237824748, value: 2}],
        subtasks: [
            {
                subId: 0,
                date: 1702237914748,
                editor: "anne",
                type: 2,
                state: 1,
                note: "long story short"
            }, {
                subId: 1,
                date: 1702237924748,
                editor: "anne",
                type: 2,
                state: 2,
                note: "another long story"
            }
        ]
    }, {
        id: 8,
        bubbleHue: 210,
        date: [{timestamp: 1702237814748, value: 1702047814748}],
        state: [{timestamp: 1702247814748, value: 1}],
        title: [{timestamp: 1702247814748, value: "Sing with the whales"}],
        description: [{timestamp: 1702247824748, value: "even more things todo"}],
        dueDate: [{timestamp: 1702247824748, value: "2024-03-08"}],
        owner: [{timestamp: 1702247824748, value: "fabian"}],
        prio: [{timestamp: 1702247824748, value: 0}],
        subtasks: [
            {
                subId: 0,
                date: 1702247914748,
                editor: "fabian",
                type: 3,
                state: 1,
                note: "boring story"
            }, {
                subId: 1,
                date: 1702247924748,
                editor: "anne",
                type: 2,
                state: 2,
                note: "never ending story"
            }
        ]
    }, {
        id: 9,
        bubbleHue: 180,
        date: [{timestamp: 1702237814748, value: 1701227814748}],
        state: [{timestamp: 1702227814748, value: -1}],
        title: [{timestamp: 1702227814748, value: "Milk the goat"}],
        description: [{timestamp: 1702227824748, value: "things todoooo"}, {timestamp: 1702227829748, value: "things to do"}],
        dueDate: [{timestamp: 1702227824748, value: "2024-03-09"}],
        owner: [{timestamp: 1702227824748, value: "bo"}],
        prio: [{timestamp: 1702227824748, value: 1}],
        subtasks: [
            {
                subId: 0,
                date: 1702227914748,
                editor: "bo",
                type: 2,
                state: 1,
                note: "looooooong string"
            }
        ]
    }, {
        id: 10,
        bubbleHue: 210,
        date: [{timestamp: 1702237814748, value: 1700137814748}],
        state: [{timestamp: 1702237814748, value: 1}],
        title: [{timestamp: 1703237814748, value: "Fly with the eagle"}],
        description: [{timestamp: 1702237824748, value: "many things todo"}],
        dueDate: [{timestamp: 1702237824748, value: "2024-01-10"}],
        owner: [{timestamp: 1702237824748, value: "anne"}],
        prio: [{timestamp: 1702237824748, value: 2}],
        subtasks: [
            {
                subId: 0,
                date: 1702237914748,
                editor: "anne",
                type: 2,
                state: 1,
                note: "long story short"
            }, {
                subId: 1,
                date: 1702237924748,
                editor: "anne",
                type: 2,
                state: 2,
                note: "another long story"
            }
        ]
    }, {
        id: 11,
        bubbleHue: 150,
        date: [{timestamp: 1702237814748, value: 1699047814748}],
        state: [{timestamp: 1702247814748, value: 1}],
        title: [{timestamp: 1702247814748, value: "Finally talk to a human being before you become an animal yourself"}],
        description: [{timestamp: 1702247824748, value: "even more things todo even more things todo even more things todo even more things todo even more things todo"}],
        dueDate: [{timestamp: 1702247824748, value: "2024-03-11"}],
        owner: [{timestamp: 1702247824748, value: "liu"}],
        prio: [{timestamp: 1702247824748, value: 0}],
        subtasks: [
            {
                subId: 0,
                date: 1702247914748,
                editor: "liu",
                type: 3,
                state: 1,
                note: "boring story"
            }, {
                subId: 1,
                date: 1702247924748,
                editor: "liu",
                type: 2,
                state: 2,
                note: "never ending story"
            }
        ]
    }
];

const priority = [
    [0, "none"],
    [-1, "done"],
    [1, "pending"],
    [2, "urgent"],
    [3, "critical"]
];
const priorityIndexes = [];
priority.forEach(e => {
    priorityIndexes.push(e[0])
});
const priorityValues = [];
priority.forEach(e => {
    priorityValues.push(e[1])
});

const subtasksType = [
    [0, "not defined"],
    [1, "face to face"],
    [2, "phone call"],
    [3, "e-mail"],
    [4, "text message"],
    [5, "information"],
    [6, "other"]
];
const subtasksTypeIndexes = [];
subtasksType.forEach(e => {
    subtasksTypeIndexes.push(e[0])
});
const subtasksTypeValues = [];
subtasksType.forEach(e => {
    subtasksTypeValues.push(e[1])
});

const subtasksState = [
    [0, "not defined",],
    [-1, "done",],
    [1, "waiting for response",],
    [2, "to be done",],
    [3, "other"]
];
const subtasksStateIndexes = [];
subtasksState.forEach(e => {
    subtasksStateIndexes.push(e[0])
});
const subtasksStateValues = [];
subtasksState.forEach(e => {
    subtasksStateValues.push(e[1])
});

const currentUser = "fabian";


// 	 ###### 	#       	 #####  	######  	 #####  	#       	 ###### 
// 	#       	#       	#     # 	#     # 	#     # 	#       	#       
// 	#   ### 	#       	#     # 	######  	####### 	#       	 #####  
// 	#     # 	#       	#     # 	#     # 	#     # 	#       	      # 
// 	 #####  	 ###### 	 #####  	######  	#     # 	 ###### 	######  

sortedTickets = tickets.filter(element => element);
currentTicketId = -1;
listType = "table";

const modalTicketBorderWidth = "18px";

const modalBubbles = document.querySelector(".modalBubbles");
const bubble = document.querySelectorAll(".bubble");
const ticketList = document.querySelector(".ticketList");
const list = document.querySelector(".list");
const btnSort = document.querySelectorAll(".btnSort");
const btnSortUp = document.querySelectorAll(".btnSortUp");
const btnSortDown = document.querySelectorAll(".btnSortDown");
const btnFilter = document.querySelectorAll(".btnFilter");
const btnUndoFilter = document.querySelectorAll(".btnUndoFilter");
const modals = document.querySelectorAll(".modal");
const modalTicket = document.querySelector(".modalTicket");
const modalSettings = document.querySelector(".modalSettings");
const modalFilter = document.querySelector(".modalFilter");
const modalSearch = document.querySelector(".modalSearch");
const grpArrows = document.querySelectorAll(".grpArrows");
const entry = document.querySelector(".entry");
const mdBtn = document.querySelectorAll(".mdBtn");
const modalConfirmDone = document.querySelector(".modalConfirmDone");

const doQuSe = (target) => {
    const [targetString] = Object.keys({target})
    varName = document.querySelector(targetString);
};

/* const doQuSeAll = (target) => {
    const [targetString] = Object.keys({target})
    varName = document.querySelector(targetString);
}; */

doQuSe(logo);
doQuSe(logoStacked);
doQuSe(btnNewTicket);
doQuSe(btnSettings);
doQuSe(btnLightMode);
doQuSe(btnDarkMode);
doQuSe(btnTicketList);
doQuSe(btnBubbleList);
doQuSe(btnStartTable);
doQuSe(btnStartBubbles);
doQuSe(btnSearch);
doQuSe(inpSearch);
doQuSe(btnStartSearch);
doQuSe(btnDismissSearch);
doQuSe(btnResetSearch);

doQuSe(btnSortByDate);
doQuSe(btnFilterByDate);
doQuSe(btnSortByTitle);
doQuSe(btnFilterByTitle);
doQuSe(btnSortByDescription);
doQuSe(btnFilterByDescription);
doQuSe(btnSortByDueDate);
doQuSe(btnFilterByDueDate);
doQuSe(btnSortByOwner);
doQuSe(btnFilterByOwner);
doQuSe(btnSortByPriority);
doQuSe(btnFilterByPriority);
doQuSe(btnSortUpByDate);
doQuSe(btnSortDownByDate);
doQuSe(btnSortUpByTitle);
doQuSe(btnSortDownByTitle);
doQuSe(btnSortUpByDescription);
doQuSe(btnSortDownByDescription);
doQuSe(btnSortUpByDueDate);
doQuSe(btnSortDownByDueDate);
doQuSe(btnSortUpByOwner);
doQuSe(btnSortDownByOwner);
doQuSe(btnSortUpByPriority);
doQuSe(btnSortDownByPriority);
doQuSe(btnUndoFilterByDate);
doQuSe(btnUndoFilterByTitle);
doQuSe(btnUndoFilterByDescription);
doQuSe(btnUndoFilterByDueDate);
doQuSe(btnUndoFilterByOwner);
doQuSe(btnUndoFilterByPriority);

doQuSe(btnDismissFilter);

doQuSe(mdTitle);
doQuSe(mdInpTitle);
doQuSe(mdDate);
doQuSe(mdOwner);
doQuSe(mdInpDueDate);
doQuSe(mdSelPrio);
doQuSe(mdTaDescription);
doQuSe(mdBtnDone);
doQuSe(mdBtnEdit);
doQuSe(mdBtnSaveTicket);
doQuSe(mdBtnSaveEntry);
doQuSe(mdBtnSaveEditedTicket);
doQuSe(mdBtnDismiss);
doQuSe(mdBtnAddEntry);

doQuSe(selFilter);

doQuSe(mdSubtaskDate);
doQuSe(mdSubtaskEditor);
doQuSe(mdSelSubtaskType);
doQuSe(mdSelSubtaskState);
doQuSe(mdTaNote);

doQuSe(mdTdDueDate);
doQuSe(mdTdPrio);
doQuSe(mdSpanDescription);
doQuSe(mdDivDisplay);
doQuSe(mdDivEdit);
doQuSe(mdDivDisplaySubtasks);
doQuSe(mdHr);
doQuSe(mdInpColor)
doQuSe(frmTicket);
doQuSe(frmEntry);

doQuSe(btnConfirmDone);
doQuSe(btnDismissDone);

// doQuSe();
// doQuSe();
// doQuSe();
// doQuSe();

const showAlert = (text) => {
    document.querySelector("#alert").style.display = "block";
        document.querySelector("#alert").innerHTML = `<p>${text}</p>`;
        setTimeout(() => {
            document.querySelector("#alert").innerHTML = "";
            document.querySelector("#alert").style.display = "none";
        }, 3000);
};

btnLightMode.onclick = () => {
    document.body.classList.add("light-mode");
    const bubble = document.querySelectorAll(".bubble");
    document.querySelectorAll("img").forEach(e => {
        e.classList.remove("imgInvert");
    });
    modalSettings.style.display = "none";
}

btnDarkMode.onclick = () => {
    document.body.classList.remove("light-mode");
    const bubble = document.querySelectorAll(".bubble");
    bubble.forEach((e) => {
        e.classList.remove("brightBubble");
    });
    document.querySelectorAll("img").forEach(e => {
        e.classList.add("imgInvert");
    });
    logo.classList.remove("imgInvert");
    logoStacked.classList.remove("imgInvert");
    modalSettings.style.display = "none";
}

const dateToString = (jsTimestamp) => {
    if (jsTimestamp === "") {
        return ""
    } else {
        let year = new Date(jsTimestamp).getFullYear();
        let month = new Date(jsTimestamp).getMonth() + 1;
        if (month < 10) {month = `0${month}`};
        let day = new Date(jsTimestamp).getDate();
        if (day < 10) {day = `0${day}`};
        return `${year}-${month}-${day}`
    };
    
};

const dateAndTimeToString = (jsTimestamp) => {
    if (jsTimestamp === "") {
        return ""
    } else {
        let year = new Date(jsTimestamp).getFullYear();
        let month = new Date(jsTimestamp).getMonth() + 1;
        if (month < 10) {month = `0${month}`};
        let day = new Date(jsTimestamp).getDate();
        if (day < 10) {day = `0${day}`};
        let hour = new Date(jsTimestamp).getHours();
        if (hour < 10) {hour = `0${hour}`};
        let minute = new Date(jsTimestamp).getMinutes();
        if (minute < 10) {minute = `0${minute}`};
        return `${year}-${month}-${day} | ${hour}:${minute}`
    }
};

const rank = (listArray) => {
    listArray.sort((a, b) => {
        if (a.dueDate.at(-1).value > b.dueDate.at(-1).value) {return 1}
        if (a.dueDate.at(-1).value < b.dueDate.at(-1).value) {return -1}
        return 0;
    });
    listArray.forEach(e => {
        if (e.prio.at(-1).value > 1 && e.dueDate.at(-1).value <= dateToString(Date.now()) && e.dueDate.at(-1).value != "") {
            e.ranking = 5;
        } else if (e.prio.at(-1).value > 2) {
            e.ranking = 4;
        } else if (e.prio.at(-1).value > 1) {
            e.ranking = 3;
        } else if (e.dueDate.at(-1).value <= dateToString(Date.now()) && e.dueDate.at(-1).value != "") {
            e.ranking = 2;
        } else if (e.dueDate.at(-1).value != "") {
            e.ranking = 1;
        } else if (e.dueDate.at(-1).value === "") {
            e.ranking = 0
        }
    });
    listArray.sort((a, b) => {
        if (a.ranking < b.ranking) {return 1}
        if (a.ranking > b.ranking) {return -1}
        return 0;
    });
    return listArray;
}
 
const renderBubbles = (listArray) => {
    modals.forEach(e => {
        e.style.display = "none";
    });
    modalBubbles.style.display = "block";
    const offsetWidth = modalBubbles.offsetWidth;

    rank(listArray);

    modalBubbles.innerHTML = "";
    for (i = 0; i < listArray.length; i++) {
        let ticketId = listArray[i].id;
        if (listArray[i].prio.at(-1).value != -1) {
            let factor = 1;
            if (offsetWidth >= 1502) {factor = 3}
            else if (offsetWidth >= 876) {factor = 2}
            else if (offsetWidth < 876) {factor = 1};
            let marginLeft = Math.floor(Math.random() * (offsetWidth / factor - 360));
            let marginTop = Math.floor(Math.random() * 50);

            let title = listArray[i].title.at(-1).value;
            if (title.length > 20) {title = title.substring(0, 30) + " ..."};
            let description = listArray[i].description.at(-1).value;
            if (description.length > 30) {description = description.substring(0, 25) + " ..."};
            
            let warningPrio = "";
            let randomTime = Math.random() * 4 + 6;
            if (listArray[i].prio.at(-1).value > 1) {warningPrio = `<span class="iconMini"><img src="pix/warning.webp" title="high priority" style="animation: flash ${randomTime}s ease-in infinite;"></span>`}
            
            let warningDue = "";
            if (listArray[i].dueDate.at(-1).value <= dateToString(Date.now()) && listArray[i].dueDate.at(-1).value != "") {
                warningDue = `<img src="pix/alarmClock.webp" title="due"  style="animation: flash ${randomTime}s ease-out infinite;">`
            }
            let infoString = `<p class="small">due ${listArray[i].dueDate.at(-1).value}<br>
            <span class="iconMini">${warningDue} </span> ${warningPrio}</p>`;
            if (listArray[i].dueDate.at(-1).value === "") {infoString = `${warningPrio}`};
            
            modalBubbles.insertAdjacentHTML("beforeend", `
            <div class="grid-element">
                <div class="bubble" id="bubble_${ticketId}" style="margin-top: ${marginTop}px; margin-left: ${marginLeft}px; border: 6px solid hsl(${listArray[i].bubbleHue}, 20%, 50%); border-left: 24px solid hsl(${listArray[i].bubbleHue}, 20%, 50%); border-right: 24px solid hsl(${listArray[i].bubbleHue}, 20%, 50%);">
                    <p class="small">${listArray[i].owner.at(-1).value}</p>
                    <p class="small">${dateAndTimeToString(listArray[i].date.at(-1).value)}</p>
                    <h3 style="color: hsl(${listArray[i].bubbleHue}, 20%, 50%);">${title}</h3>
                    <p>${description}</p>
                    ${infoString}
                </div>
            </div>
            `);
            let currentBubble = document.querySelector(`#bubble_${listArray[i].id}`);
            currentBubble.addEventListener("click", () => {
                displayTicket(ticketId);
            });
        }
        
    };

    let modalBubblesImg = document.querySelectorAll(".modalBubbles img");
    if (document.body.classList.contains("light-mode")) {
        modalBubblesImg.forEach(e => {
            e.classList.remove("imgInvert");
        })
    } else {
        modalBubblesImg.forEach(e => {
            e.classList.add("imgInvert");
        });
    };

    window.scroll(0, 0);
};

const renderList = (listArray) => {
    for (i= ticketList.rows.length - 1; i > 0 ; i--) {
        ticketList.rows[i].remove();
        ticketList.tBodies[i].remove();
    }

    rank(listArray);

    listArray.forEach(element => {
        if (element.prio.at(-1).value != -1) {
            let title = element.title.at(-1).value;
            if (title.length > 20) {title = title.substring(0, 18) + "..."};
            let description = element.description.at(-1).value;
            let tdWarnPrioString = "";
            let tdWarnDueString = "";
            if (element.prio.at(-1).value > 1) {tdWarnPrioString = `<img src="pix/warning.webp" title="high priority">`};
            if (element.dueDate.at(-1).value < dateToString(Date.now()) && element.dueDate.at(-1).value != "") {tdWarnDueString = `<img src="pix/alarmClock.webp" title="due">`};
            ticketList.insertAdjacentHTML("beforeend", `
            <tr class="listItem" id="ticket_${element.id}">
            <td>${dateToString(element.date.at(-1).value)}</td><td style="border-left: 6px solid hsl(${element.bubbleHue}, 20%, 50%">${title}<div class="tdWarnPrio">${tdWarnPrioString}</div><div class="tdWarnDue">${tdWarnDueString}</div></td><td>${description}</td><td>${element.dueDate.at(-1).value}</td><td>${element.owner.at(-1).value}</td><td>${priorityValues[priorityIndexes.indexOf(element.prio.at(-1).value)]}</td>
            </tr>
            `);
            document.querySelector(`#ticket_${element.id}`).addEventListener("click", () => {
                displayTicket(element.id);
            });
        };
    });
    if (document.body.classList.contains("light-mode") === false) {
        document.querySelectorAll(".list img").forEach(e => {
            e.classList.add("imgInvert")
        });
    };
    window.scroll(0, 0);
};

const displayTicketList = () => {
    listType = "table";
    modals.forEach(element => {
        element.style.display = "none";
    });
    list.style.display = "block";
    btnStartBubbles.style.display = "block";
    btnStartTable.style.display = "none";
    window.scroll(0, 0);
};

const displayBubbleList = () => {
    listType = "bubbles";
    modals.forEach(element => {
        element.style.display = "none";
    });
    modalBubbles.style.display = "grid";
    btnStartBubbles.style.display = "none";
    btnStartTable.style.display = "block";
    window.scroll(0, 0);
};

const displayModalTicket = () => {
    if (listType === "bubbles") {
        btnStartBubbles.style.display = "block";
        btnStartTable.style.display = "none";
    } if (listType === "table") {
        btnStartBubbles.style.display = "none";
        btnStartTable.style.display = "block";
    };
    modals.forEach(element => {
        element.style.display = "none";
    });
    modalTicket.style.display = "block";
    frmTicket.reset();
    mdBtn.forEach(e => {
        e.style.display = "none";
    });
    entry.style.display = "none";
    window.scroll(0, 0);
};

const displayTicket = (ticketId) => {
    displayModalTicket();
    modalTicket.style.borderTop = `${modalTicketBorderWidth} solid hsl(${tickets[ticketId].bubbleHue}, 25%, 50%)`;
    modalTicket.style.borderBottom = `${modalTicketBorderWidth} solid hsl(${tickets[ticketId].bubbleHue}, 25%, 50%)`;
    mdDivDisplay.style.display = "block";
    mdDivEdit.style.display = "none";
    entry.style.display = "none";
    mdBtnEdit.style.display = "block";
    mdBtnAddEntry.style.display = "block";
    mdBtnDone.style.display = "block";
    mdDate.innerHTML = dateAndTimeToString(tickets[ticketId].date.at(-1).value);
    mdOwner.innerHTML = tickets[ticketId].owner.at(-1).value;
    mdTitle.innerHTML = tickets[ticketId].title.at(-1).value;
    mdTitle.style.color = `hsl(${tickets[ticketId].bubbleHue}, 20%, 50%)`;
    mdTdDueDate.innerHTML = tickets[ticketId].dueDate.at(-1).value;
    mdTdDueDate.style.color = `hsl(${tickets[ticketId].bubbleHue}, 20%, 50%)`;
    mdTdPrio.innerHTML = priorityValues[priorityIndexes.indexOf(tickets[ticketId].prio.at(-1).value)]; // tickets[ticketId].prio.at(-1).value;
    mdTdPrio.style.color = `hsl(${tickets[ticketId].bubbleHue}, 20%, 50%)`;
    mdSpanDescription.innerHTML = tickets[ticketId].description.at(-1).value;
    mdSpanDescription.style.color = `hsl(${tickets[ticketId].bubbleHue}, 20%, 50%)`;
    mdHr.style.borderBottom = `6px solid hsl(${tickets[ticketId].bubbleHue}, 20%, 50%)`;
    mdDivDisplaySubtasks.innerHTML = "";
    if (tickets[ticketId].subtasks.length > 0) {
        tickets[ticketId].subtasks.forEach(e => {
            mdDivDisplaySubtasks.insertAdjacentHTML("beforeend", `
            <p>${dateAndTimeToString(e.date)} | ${e.editor}</p>
            <p style="color: hsl(${tickets[ticketId].bubbleHue}, 20%, 50%)"><span class="dimmedFont">note</span><br><b>${e.note}</b></p>
            <table>
                <tr>
                    <td class="dimmedFont">type</td>
                    <td>${subtasksTypeValues[subtasksTypeIndexes.indexOf(e.type)]}</td>
                </tr>
                <tr>
                    <td class="dimmedFont">state</td>
                    <td>${subtasksStateValues[subtasksStateIndexes.indexOf(e.state)]}</td>
                </tr>
            </table>
            <hr>
            `)
        })
    };
    currentTicketId = ticketId;
};

const displayNewTicket = () => {
    displayModalTicket();
    let hue = (Math.random() * 12).toFixed(0) * 30;
    modalTicket.style.borderTop = `${modalTicketBorderWidth} solid hsl(${hue}, 25%, 50%)`;
    modalTicket.style.borderBottom = `${modalTicketBorderWidth} solid hsl(${hue}, 25%, 50%)`;
    mdInpColor.value = hue;
    mdDivDisplay.style.display = "none";
    mdDivEdit.style.display = "block";
    mdBtnSaveTicket.style.display ="block";
    mdBtnAddEntry.style.display ="block";
    mdBtnDismiss.style.display ="block";
    mdDate.innerHTML = `${dateToString(Date.now())}`;
    mdOwner.innerHTML = currentUser;
    mdSelPrio.innerHTML = "";
    priority.forEach(e => {
        mdSelPrio.insertAdjacentHTML("beforeend", `
        <option value=${e[0]}>${e[1]}</option>
        `);
    });
};

const displaySubtaskEdit = () => {
    entry.style.display = "block";
    frmEntry.reset();
    mdBtnAddEntry.style.display = "none";
    mdBtnDismiss.style.display = "block";
    if (mdDivEdit.style.display === "block") {                      // new ticket
        mdBtnSaveTicket.style.display = "block";
        mdBtnSaveEntry.style.display = "none";
        mdBtnSaveEditedTicket.style.display = "none";
    /* } else if () {                                                  // edit ticket
        mdBtnSaveTicket.style.display = "none";
        mdBtnSaveEntry.style.display = "none";
        mdBtnSaveEditedTicket.style.display = "block"; */
    } else {                                                        // existing ticket
        mdBtnSaveTicket.style.display = "none";
        mdBtnSaveEntry.style.display = "block";
        mdBtnSaveEditedTicket.style.display = "none";
    };
    mdSubtaskDate.innerHTML = dateToString(Date.now());
    mdSubtaskEditor.innerHTML = currentUser;
    mdSelSubtaskType.innerHTML = "";
    subtasksType.forEach(e => {
        mdSelSubtaskType.insertAdjacentHTML("beforeend", `
        <option value=${e[0]}>${e[1]}</option>
        `);
    });
    mdSelSubtaskState.innerHTML = "";
    subtasksState.forEach(e => {
        mdSelSubtaskState.insertAdjacentHTML("beforeend", `
        <option value=${e[0]}>${e[1]}</option>
        `)
    });
    mdBtnSaveEntry.scrollIntoView();
};

// 	 ###### 	 #####  	 #####  	####### 
// 	#       	#     # 	#     # 	   #    
// 	 #####  	#     # 	######  	   #    
// 	      # 	#     # 	#  #    	   #    
// 	######  	 #####  	#    #  	   #    

btnNewTicket.addEventListener("click", displayNewTicket);

btnTicketList.addEventListener("click", () => {
    listType = "table";
    displayTicketList();
});
btnStartTable.addEventListener("click", displayTicketList);
btnBubbleList.addEventListener("click", () => {
    listType = "bubbles";
    displayBubbleList();
});
btnStartBubbles.addEventListener("click", displayBubbleList);

const sortTickets = (criterion, direction) => {
    sortedTickets.sort((a, b) => {
        let index = 1;
        if (direction === "down") {index = -1};
        if (a[criterion].at(-1).value < b[criterion].at(-1).value) {
          return -1 * index;
        }
        if (a[criterion].at(-1).value > b[criterion].at(-1).value) {
          return 1 * index;
        }
        return 0;
    });
    renderList(sortedTickets);
};

const resetSortAndFilterButtons = () => {
    btnSort.forEach(element => {
        element.style.display = "block";
        element.style.background = "transparent";
    });
    btnSortUp.forEach(element => {
        element.style.background = "transparent";
        element.style.display = "none";
    });
    btnSortDown.forEach(element => {
        element.style.background = "transparent";
        element.style.display = "none";
    });
    btnFilter.forEach(element => {
        element.style.display = "block";
        element.style.background = "transparent";
    });
    btnUndoFilter.forEach(element => {
        element.style.background = "transparent";
        element.style.display = "none";
    });
};

// ### SORT BY DATE ###

const sortByDate = () => {
    resetSortAndFilterButtons();
    btnSortByDate.style.display = "none";
    btnSortUpByDate.style.display = "block";
    btnSortUpByDate.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("date", "up");
};

btnSortByDate.addEventListener("click", sortByDate);

btnSortUpByDate.addEventListener("click", () => {
    resetSortAndFilterButtons();
    btnSortByDate.style.display = "none";
    btnSortDownByDate.style.display = "block";
    btnSortDownByDate.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("date", "down");
});

btnSortDownByDate.addEventListener("click", sortByDate);

// ### SORT BY TITLE ###

const sortByTitle = () => {
    resetSortAndFilterButtons();
    btnSortByTitle.style.display = "none";
    btnSortUpByTitle.style.display = "block";
    btnSortUpByTitle.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("title", "up");
}

btnSortByTitle.addEventListener("click", sortByTitle);

btnSortUpByTitle.addEventListener("click", () => {
    resetSortAndFilterButtons();
    btnSortByTitle.style.display = "none";
    btnSortDownByTitle.style.display = "block";
    btnSortDownByTitle.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("title", "down");
});

btnSortDownByTitle.addEventListener("click", sortByTitle);

// ### SORT BY DESCRIPTION ###

const sortByDescription = () => {
    resetSortAndFilterButtons();
    btnSortByDescription.style.display = "none";
    btnSortUpByDescription.style.display = "block";
    btnSortUpByDescription.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("description", "up");
}

btnSortByDescription.addEventListener("click", sortByDescription);

btnSortUpByDescription.addEventListener("click", () => {
    resetSortAndFilterButtons();
    btnSortByDescription.style.display = "none";
    btnSortDownByDescription.style.display = "block";
    btnSortDownByDescription.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("description", "down");
});

btnSortDownByDescription.addEventListener("click", sortByDescription);

// ### SORT BY DUEDATE ###

const sortByDueDate = () => {
    resetSortAndFilterButtons();
    btnSortByDueDate.style.display = "none";
    btnSortUpByDueDate.style.display = "block";
    btnSortUpByDueDate.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("dueDate", "up");
}

btnSortByDueDate.addEventListener("click", sortByDueDate);

btnSortUpByDueDate.addEventListener("click", () => {
    resetSortAndFilterButtons();
    btnSortByDueDate.style.display = "none";
    btnSortDownByDueDate.style.display = "block";
    btnSortDownByDueDate.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("dueDate", "down");
});

btnSortDownByDueDate.addEventListener("click", sortByDueDate);

// ### SORT BY OWNER ###

const sortByOwner = () => {
    resetSortAndFilterButtons();
    btnSortByOwner.style.display = "none";
    btnSortUpByOwner.style.display = "block";
    btnSortUpByOwner.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("owner", "up");
}

btnSortByOwner.addEventListener("click", sortByOwner);

btnSortUpByOwner.addEventListener("click", () => {
    resetSortAndFilterButtons();
    btnSortByOwner.style.display = "none";
    btnSortDownByOwner.style.display = "block";
    btnSortDownByOwner.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("owner", "down");
});

btnSortDownByOwner.addEventListener("click", sortByOwner);

// ### SORT BY PRIORITY ###

const sortByPriority = () => {
    resetSortAndFilterButtons();
    btnSortByPriority.style.display = "none";
    btnSortUpByPriority.style.display = "block";
    btnSortUpByPriority.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("prio", "up");
}

btnSortByPriority.addEventListener("click", sortByPriority);

btnSortUpByPriority.addEventListener("click", () => {
    resetSortAndFilterButtons();
    btnSortByPriority.style.display = "none";
    btnSortDownByPriority.style.display = "block";
    btnSortDownByPriority.style.background = "radial-gradient(circle at center, var(--accent-turquois) 0, var(--accent-turquois) 66%, transparent 67%)";
    sortTickets("prio", "down");
});

btnSortDownByPriority.addEventListener("click", sortByPriority);

// 	####### 	   #    	#       	####### 	 ###### 	 #####  	 ###### 
// 	   #    	   #    	#       	   #    	#       	#     # 	#       
// 	  ###   	   #    	#       	   #    	######  	######  	 #####  
// 	   #    	   #    	#       	   #    	#       	#  #    	      # 
// 	   #    	   #    	 ###### 	   #    	 ###### 	#    #  	######  

btnDismissFilter.addEventListener("click", () => {
    selFilter.innerHTML = `<option value="" selected disabled>select filter value</option>`;
    removeFilterListeners();
    modalFilter.style.display = "none";
});

const prepareSelFilter = (type) => {
    modalFilter.style.display = "block";
    let selArray = [];
    tickets.forEach(e => {
        selArray.push(e[type].at(-1).value);
    });
    let filteredSelArray = selArray.filter((element, index) => {
        return selArray.indexOf(element) === index;
    });
    filteredSelArray.sort((a, b) => {
        if (a > b) {
            return 1;
          }
          if (a < b) {
            return -1;
          }
          return 0;
    });
    filteredSelArray.forEach(e => {
        if (e > 1690000000000) {
            selFilter.insertAdjacentHTML("beforeend", `
                <option value="${dateToString(e)}">${dateToString(e)}</option>
            `)
        } else {
            selFilter.insertAdjacentHTML("beforeend", `
                <option value="${e}">${e}</option>
            `)
        }
    });
};

// ######################
// ### FILTER BY TYPE ###
// ######################

const fnFilterByDate = () => {
    let filterValue = selFilter.value;
    filteredTickets = sortedTickets.filter((element) => {
        return dateToString(element.date.at(-1).value) === filterValue;
    });
    modalFilter.style.display = "none";
    resetSortAndFilterButtons();
    grpArrows.forEach(e => {
        e.style.display = "none";
    });
    btnUndoFilterByDate.style.display = "block";
    btnUndoFilterByDate.style.background = "radial-gradient(circle at center, var(--accent-red) 0, var(--accent-red) 66%, transparent 67%)";
    selFilter.innerHTML = `<option value="" selected disabled>select filter value</option>`;
    renderList(filteredTickets);
};

const fnFilterByTitle = () => {
    let filterValue = selFilter.value;
    filteredTickets = sortedTickets.filter((element) => {
        return (element.title.at(-1).value).toString() === filterValue;
    });
    modalFilter.style.display = "none";
    resetSortAndFilterButtons();
    grpArrows.forEach(e => {
        e.style.display = "none";
    });
    btnUndoFilterByTitle.style.display = "block";
    btnUndoFilterByTitle.style.background = "radial-gradient(circle at center, var(--accent-red) 0, var(--accent-red) 66%, transparent 67%)";
    selFilter.innerHTML = `<option value="" selected disabled>select filter value</option>`;
    renderList(filteredTickets);
};

const fnFilterByDescription = () => {
    let filterValue = selFilter.value;
    filteredTickets = sortedTickets.filter((element) => {
        return (element.description.at(-1).value).toString() === filterValue;
    });
    modalFilter.style.display = "none";
    resetSortAndFilterButtons();
    grpArrows.forEach(e => {
        e.style.display = "none";
    });
    btnUndoFilterByDescription.style.display = "block";
    btnUndoFilterByDescription.style.background = "radial-gradient(circle at center, var(--accent-red) 0, var(--accent-red) 66%, transparent 67%)";
    selFilter.innerHTML = `<option value="" selected disabled>select filter value</option>`;
    renderList(filteredTickets);
};

const fnFilterByDueDate = () => {
    let filterValue = selFilter.value;
    filteredTickets = sortedTickets.filter((element) => {
        return element.dueDate.at(-1).value === filterValue;
    });
    modalFilter.style.display = "none";
    resetSortAndFilterButtons();
    grpArrows.forEach(e => {
        e.style.display = "none";
    });
    btnUndoFilterByDueDate.style.display = "block";
    btnUndoFilterByDueDate.style.background = "radial-gradient(circle at center, var(--accent-red) 0, var(--accent-red) 66%, transparent 67%)";
    selFilter.innerHTML = `<option value="" selected disabled>select filter value</option>`;
    renderList(filteredTickets);
};

const fnFilterByOwner = () => {
    let filterValue = selFilter.value;
    filteredTickets = sortedTickets.filter((element) => {
        return (element.owner.at(-1).value).toString() === filterValue;
    });
    modalFilter.style.display = "none";
    resetSortAndFilterButtons();
    grpArrows.forEach(e => {
        e.style.display = "none";
    });
    btnUndoFilterByOwner.style.display = "block";
    btnUndoFilterByOwner.style.background = "radial-gradient(circle at center, var(--accent-red) 0, var(--accent-red) 66%, transparent 67%)";
    selFilter.innerHTML = `<option value="" selected disabled>select filter value</option>`;
    renderList(filteredTickets);
};

const fnFilterByPriority = () => {
    let filterValue = selFilter.value;
    filteredTickets = sortedTickets.filter((element) => {
        return (element.prio.at(-1).value).toString() === filterValue;
    });
    modalFilter.style.display = "none";
    resetSortAndFilterButtons();
    grpArrows.forEach(e => {
        e.style.display = "none";
    });
    btnUndoFilterByPriority.style.display = "block";
    btnUndoFilterByPriority.style.background = "radial-gradient(circle at center, var(--accent-red) 0, var(--accent-red) 66%, transparent 67%)";
    selFilter.innerHTML = `<option value="" selected disabled>select filter value</option>`;
    renderList(filteredTickets);
};

// 	 ###### 	 ###### 	 #####  	 #####  	 ###### 	#     # 
// 	#       	#       	#     # 	#     # 	#       	#     # 
// 	 #####  	######  	####### 	######  	#       	####### 
// 	      # 	#       	#     # 	#  #    	#       	#     # 
// 	######  	 ###### 	#     # 	#    #  	 ###### 	#     # 

const search = () => {
    let string = inpSearch.value.toLowerCase();
    let result = [];
    if (string === "") {
        showAlert("please enter search phrase");
        return;
    };
    tickets.forEach(e => {
        if (dateToString(e.date.at(-1).value).search(string) >= 0) {result.push(e)};
        if (e.title.at(-1).value.toLowerCase().search(string) >= 0) {result.push(e)};
        if (e.description.at(-1).value.toLowerCase().search(string) >= 0) {result.push(e)};
        if (e.dueDate.at(-1).value.search(string) >= 0) {result.push(e)};
        if (e.owner.at(-1).value.toLowerCase().search(string) >= 0) {result.push(e)};
        if ((e.prio.at(-1).value).toString().search(string) >= 0) {result.push(e)};
        e.subtasks.forEach(el => {
            if (dateToString(el.date).search(string) >= 0) {result.push(e)};
            if (el.note.toLowerCase().search(string) >= 0) {result.push(e)};
        });
    });
    if (result.length === 0) {
        console.log("result.length: " + result.length);
        showAlert("no matches");
    } else {
        let filteredResult = result.filter((element, index) => {
            return result.indexOf(element) === index;
        });
        console.log("result.length" + result.length);
        for (i= ticketList.rows.length - 1; i > 0 ; i--) {
            ticketList.rows[i].remove();
            ticketList.tBodies[i].remove();
        };
        grpArrows.forEach(e => {
            e.style.display = "none";
        });
        filteredResult.forEach(element => {
            ticketList.insertAdjacentHTML("beforeend", `
            <tr class="listItem" id="ticket_${element.id}">
                <td>${dateToString(element.date.at(-1).value)}</td><td style="border-left: 6px solid hsl(${element.bubbleHue}, 25%, 50%">${element.title.at(-1).value}</td><td>${element.description.at(-1).value}</td><td>${element.dueDate.at(-1).value}</td><td>${element.owner.at(-1).value}</td><td>${element.prio.at(-1).value}</td>
            </tr>
            `);
            document.querySelector(`#ticket_${element.id}`).addEventListener("click",  () => {
                displayTicket(element.id);
            });
            console.log("filteredResult.length: " + filteredResult.length);
        });
        inpSearch.value = "";
        modals.forEach(e => {
            e.style.display = "none";
        });
        renderBubbles(filteredResult);
        if (listType === "bubbles") {
            displayBubbleList();
        } else if (listType === "table") {
            displayTicketList();
        }
        // list.style.display = "block";
        modalSearch.style.display = "none";
        btnSearch.style.display = "none";
        btnResetSearch.style.display = "block";
    };    
};



// 	####### 	   #    	 ###### 	#     # 	 ###### 	####### 
// 	   #    	   #    	#       	#  #    	#       	   #    
// 	   #    	   #    	#       	##      	######  	   #    
// 	   #    	   #    	#       	#  #    	#       	   #    
// 	   #    	   #    	 ###### 	#     # 	 ###### 	   #    

const resetModalTicketInputs = () => {
    mdInpTitle.value = "";
    mdInpDueDate.value = "";
    mdSelPrio.innerHTML = "";
    mdTaDescription.value = "";
    mdSelSubtaskState.innerHTML = "";
    mdSelSubtaskType.innerHTML = "";
    mdTaNote.value = "";
};

const saveNewTicket = () => {
    if (mdInpTitle.value === "") {showAlert("Please enter at least a title"); return;};
    if (mdInpDueDate.value < dateToString(Date.now()) && mdInpDueDate.value != "") {showAlert("Due date is in the past"); return};
    let newTicket = {
        id: tickets.length,
        bubbleHue: mdInpColor.value,
        date: [{timestamp: Date.now(), value: Date.now()}],
        state: [{timestamp: Date.now(), value: 0}],
        title: [{timestamp: Date.now(), value: mdInpTitle.value}],
        description: [{timestamp: Date.now(), value: mdTaDescription.value}],
        dueDate: [{timestamp: Date.now(), value: mdInpDueDate.value}],
        owner: [{timestamp: Date.now(), value: currentUser}],
        prio: [{timestamp: Date.now(), value: Number(mdSelPrio.value)}],
        subtasks: []
    };
    if (mdTaNote.value != "") {
        newTicket.subtasks.push({
            subId: 0,
            date: Date.now(),
            editor: currentUser,
            type: Number(mdSelSubtaskType.value),
            state: Number(mdSelSubtaskState.value),
            note: mdTaNote.value
        });
    };    
    tickets.push(newTicket);
    sortedTickets = tickets.filter(element => element);
    /* sortedTickets.push(newTicket); */
    modalTicket.style.display = "none";
    btnResetSearch.style.display = "none";
    btnSearch.style.display = "block";
    resetModalTicketInputs();
    renderList(sortedTickets);
    renderBubbles(sortedTickets);
    if (listType === "bubbles") {
        displayBubbleList();
    } else if (listType === "table") {
        displayTicketList();
    };
};

const saveEntry = () => {
    if (mdTaNote.value === "") {showAlert("Please enter a note"); return;};
    let newEntry = {
        subId: tickets[currentTicketId].subtasks.length,
        date: Date.now(),
        editor: currentUser,
        type: Number(mdSelSubtaskType.value),
        state: Number(mdSelSubtaskState.value),
        note: mdTaNote.value
    };
    tickets[currentTicketId].subtasks.push(newEntry);
    displayTicket(currentTicketId);
};

const confirmDone = () => {
    tickets[currentTicketId].prio.push({
        timestamp: Date.now(),
        value: -1
    });
    modalConfirmDone.style.display = "none";
    modals.forEach(e => {
        e.style.display = "none";
    });
    sortedTickets = tickets.filter(element => element);
    renderList(sortedTickets);
    renderBubbles(sortedTickets);
    if (listType === "bubbles") {
        displayBubbleList();
    } else if (listType === "table") {
        displayTicketList();
    };
};

const editTicket = (ticketId) => {
    mdDivDisplay.style.display = "none";
    mdBtnAddEntry.style.display = "none";
    entry.style.display = "none";
    mdBtnSaveEntry.style.display = "none";
    mdDivEdit.style.display = "block";
    mdBtn.forEach(e => {
        e.style.disply = "none"
    });
    mdSelPrio.innerHTML = "";
    priority.forEach(e => {
        mdSelPrio.insertAdjacentHTML("beforeend", `
        <option value=${e[0]}>${e[1]}</option>
        `);
    });
    mdBtnDismiss.style.display = "block";
    mdBtnSaveEditedTicket.style.display = "block";
    mdInpTitle.value = tickets[currentTicketId].title.at(-1).value;
    mdInpDueDate.value = tickets[currentTicketId].dueDate.at(-1).value;
    mdSelPrio.value = tickets[currentTicketId].prio.at(-1).value;
    mdInpColor.value = tickets[currentTicketId].bubbleHue;
    mdTaDescription.value = tickets[currentTicketId].description.at(-1).value;
};

const saveEditedTicket = () => {
    if (mdInpTitle.value != tickets[currentTicketId].title.at(-1).value) {
        tickets[currentTicketId].title.push({
            timestamp: Date.now(),
            value: mdInpTitle.value
        });
        console.log("title updated");
    }
    if (mdInpDueDate.value != tickets[currentTicketId].dueDate.at(-1).value) {
        if (mdInpDueDate.value < dateToString(Date.now()) && mdInpDueDate.value != "") {showAlert("Due date is in the past"); return};
        tickets[currentTicketId].dueDate.push({
            timestamp: Date.now(),
            value: mdInpDueDate.value
        });
        console.log("dueDate updated");
    }
    if (mdSelPrio.value != tickets[currentTicketId].prio.at(-1).value) {
        tickets[currentTicketId].prio.push({
            timestamp: Date.now(),
            value: Number(mdSelPrio.value)
        });
        console.log("prio updated");
    }
    if (mdInpColor.value != tickets[currentTicketId].bubbleHue) {
        tickets[currentTicketId].bubbleHue = mdInpColor.value;
        console.log("color updated");
    }
    if (mdTaDescription.value != tickets[currentTicketId].description.at(-1).value) {
        tickets[currentTicketId].description.push({
            timestamp: Date.now(),
            value: mdTaDescription.value
        });
        console.log("description updated");
    };
    if (mdTaNote.value != "") {
        tickets[currentTicketId].subtasks.push({
            subId: 0,
            date: Date.now(),
            editor: currentUser,
            type: Number(mdSelSubtaskType.value),
            state: Number(mdSelSubtaskState.value),
            note: mdTaNote.value
        });
    };
    modals.forEach(e => {
        e.style.display = "none"
    });
    resetModalTicketInputs();
    btnResetSearch.style.display = "none";
    btnSearch.style.display = "block";
    sortedTickets = tickets.filter(element => element);
    renderList(sortedTickets);
    renderBubbles(sortedTickets);
    if (listType === "bubbles") {
        displayBubbleList();
    } else if (listType === "table") {
        displayTicketList();
    };
}


// 	#        # 	 ###### 	####### 	 ###### 	#     # 	 ###### 	 #####  	 ###### 
// 	#        # 	#       	   #    	#       	##    # 	#       	#     # 	#       
// 	#        # 	 #####  	   #    	######  	#  #  # 	######  	######  	 #####  
// 	#        # 	      # 	   #    	#       	#   # # 	#       	#  #    	      # 
// 	 ######  # 	######  	   #    	 ###### 	#    ## 	 ###### 	#    #  	######  

btnSettings.addEventListener("click", () => {
    if (modalSettings.style.display === "none") {
        modalSettings.style.display = "block";
        // window.scroll(0, 0);
    } else {
        modalSettings.style.display = "none"
    }
});

btnFilterByDate.addEventListener("click", () => {
    prepareSelFilter("date");
    selFilter.addEventListener("change", fnFilterByDate);
});

btnFilterByTitle.addEventListener("click", () => {
    prepareSelFilter("title");
    selFilter.addEventListener("change", fnFilterByTitle);
});

btnFilterByDescription.addEventListener("click", () => {
    prepareSelFilter("description");
    selFilter.addEventListener("change", fnFilterByDescription);
});

btnFilterByDueDate.addEventListener("click", () => {
    prepareSelFilter("dueDate");
    selFilter.addEventListener("change", fnFilterByDueDate);
})

btnFilterByOwner.addEventListener("click", () => {
    prepareSelFilter("owner");
    selFilter.addEventListener("change", fnFilterByOwner);
});

btnFilterByPriority.addEventListener("click", () => {
    prepareSelFilter("prio");
    selFilter.addEventListener("change", fnFilterByPriority);
});


mdInpColor.addEventListener("change", () => {
    hue = mdInpColor.value;
    modalTicket.style.borderTop = `${modalTicketBorderWidth} solid hsl(${hue}, 25%, 50%)`;
    modalTicket.style.borderBottom = `${modalTicketBorderWidth} solid hsl(${hue}, 25%, 50%)`;
});

// ####################
// ### UNDO FILTERS ###
// ####################

const removeFilterListeners = () => {
    selFilter.removeEventListener("change", fnFilterByDate);
    selFilter.removeEventListener("change", fnFilterByTitle);
    selFilter.removeEventListener("change", fnFilterByDescription);
    selFilter.removeEventListener("change", fnFilterByDueDate);
    selFilter.removeEventListener("change", fnFilterByOwner);
    selFilter.removeEventListener("change", fnFilterByPriority);
}

btnUndoFilterByDate.addEventListener("click", () => {
    resetSortAndFilterButtons();
    selFilter.removeEventListener("change", fnFilterByDate);
    renderList(tickets);
});

btnUndoFilterByTitle.addEventListener("click", () => {
    resetSortAndFilterButtons();
    selFilter.removeEventListener("change", fnFilterByTitle);
    renderList(tickets);
});

btnUndoFilterByDescription.addEventListener("click", () => {
    resetSortAndFilterButtons();
    selFilter.removeEventListener("change", fnFilterByDescription);
    renderList(tickets);
});

btnUndoFilterByDueDate.addEventListener("click", () => {
    resetSortAndFilterButtons();
    selFilter.removeEventListener("change", fnFilterByDueDate);
    renderList(tickets);
});

btnUndoFilterByOwner.addEventListener("click", () => {
    resetSortAndFilterButtons();
    selFilter.removeEventListener("change", fnFilterByOwner);
    renderList(tickets);
});

btnUndoFilterByPriority.addEventListener("click", () => {
    resetSortAndFilterButtons();
    selFilter.removeEventListener("change", fnFilterByPriority);
    renderList(tickets);
});

btnSearch.addEventListener("click", () => {
    if (modalSearch.style.display === "block") {
        inpSearch.value = "";
        modalSearch.style.display = "none";
    } else {
        modalSearch.style.display = "block";
        // window.scroll(0, 0);
        // modalSearch.scrollIntoView();
    }
});

btnDismissSearch.addEventListener("click", () => {
    inpSearch.value = "";
    modalSearch.style.display = "none";
});

btnStartSearch.addEventListener("click", search);
inpSearch.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
        event.preventDefault();
        search();
    }
  });

btnResetSearch.addEventListener("click", () => {
    btnResetSearch.style.display = "none";
    btnSearch.style.display = "block";
    resetSortAndFilterButtons();
    sortedTickets = tickets.filter(element => element);
    renderList(sortedTickets);
    renderBubbles(sortedTickets)
    if (listType === "bubbles") {
        displayBubbleList();
    } else if (listType === "table") {
        displayTicketList();
    }
});

mdBtnSaveTicket.addEventListener("click", saveNewTicket);

mdBtnSaveEntry.addEventListener("click", saveEntry);

mdBtnDismiss.addEventListener("click", () => {
    if (listType === "bubbles") {
        displayBubbleList();
    } else if (listType === "table") {
        displayTicketList();
    }
});

mdBtnAddEntry.addEventListener("click", displaySubtaskEdit);

mdBtnDone.addEventListener("click", () => {
    modalConfirmDone.style.display = "block";
});

btnConfirmDone.addEventListener("click", confirmDone);

btnDismissDone.addEventListener("click", () => {
    modalConfirmDone.style.display = "none";
});

mdBtnEdit.addEventListener("click", () => {
    editTicket(currentTicketId);
});

mdBtnSaveEditedTicket.addEventListener("click", saveEditedTicket);

document.querySelectorAll("img").forEach(e => {
    e.classList.add("imgInvert");
});
logo.classList.remove("imgInvert");
logoStacked.classList.remove("imgInvert");

renderList(sortedTickets);
renderBubbles(sortedTickets);
if (listType === "bubbles") {
    displayBubbleList();
} else if (listType === "table") {
    displayTicketList();
}